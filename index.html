<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEBAR Image Popup</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }

    /* ▼ ポップアップ（modal） */
    #popup {
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:#fff; color:#000;
      padding:20px; border-radius:12px;
      box-shadow:0 8px 25px rgba(0,0,0,.3);
      width:85%; max-width:340px;
      display:none; z-index:100;
      font-family:"Helvetica Neue",sans-serif;
      text-align:center;
    }
    #popup h2 { margin-top:0; font-size:20px; }
    #popup img {
      width:100%; 
      border-radius:8px; 
      margin:10px 0;
    }
    #popup button {
      margin-top:15px;
      padding:10px 18px;
      border:none;
      border-radius:8px;
      background:#007aff; color:#fff;
      font-size:16px; cursor:pointer;
    }

    /* ▼ GPSログ */
    #logs {
      position:fixed; bottom:0; left:0; right:0;
      background:rgba(0,0,0,.5); color:#0f0;
      padding:4px; font-size:11px; z-index:50;
    }
  </style>
</head>

<body>

  <!-- ▼ ポップアップ -->
  <div id="popup">
    <h2 id="popupTitle">タイトル</h2>
    <img id="popupImg" src="" style="display:none;">
    <p id="popupText"></p>
    <button onclick="closePopup()">閉じる</button>
  </div>

  <div id="logs">準備中...</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >

    <!-- ▼ マーカー① -->
    <a-image id="marker1"
      class="clickable"
      src="./marker1.png"
      width="12"
      height="12"
      look-at="[gps-camera]"
      gps-entity-place="latitude: 35.83839; longitude: 139.55590;"
      visible="true">
    </a-image>

    <!-- ▼ マーカー② -->
    <a-image id="marker2"
      class="clickable"
      src="./marker2.png"
      width="12"
      height="12"
      look-at="[gps-camera]"
      gps-entity-place="latitude: 35.838194559064135; longitude: 139.55622690576655;"
      visible="true">
    </a-image>

    <!-- ▼ カメラ & タップカーソル -->
    <a-camera gps-camera rotation-reader>
      <a-cursor
        fuse="false"
        raycaster="objects: .clickable"
        geometry="primitive: circle; radius: 0.003"
        material="color: black; opacity: 0.8">
      </a-cursor>
    </a-camera>

  </a-scene>


<script>
/* ----------------------------------------
   ▼ ポップアップ要素取得
---------------------------------------- */
const popup = document.getElementById("popup");
const popupTitle = document.getElementById("popupTitle");
const popupText = document.getElementById("popupText");
const popupImg = document.getElementById("popupImg");
const logs = document.getElementById("logs");

/* ----------------------------------------
   ▼ マーカーごとのデータ（タイトル・文章・画像）
   ※ 画像ファイルを GitHub に置いて参照してください
---------------------------------------- */
const popupData = {
  marker1: {
    title: "昔の高輪ゲートウェイ駅周辺",
    text: "高輪は 武蔵野台地の“東端の尾根” に位置し、当時は海が現在よりも西側に迫っていました。",
    img: "./sample1.jpg"   // ← 好きな画像に変更
  },
  marker2: {
    title: "高縄原合戦",
    text: "大永四年（一五二四）正月十三日。小田原を本拠地に、相模から武蔵に進出して関東制覇をもくろむ北条氏綱と、関東管領の栄光を死守しようとする江戸城主上杉（扇谷）朝興の軍勢による戦がありました。<br>合戦は籠城を避けて野戦に打って出た上杉勢が大敗を喫し、朝興は河越城へ逃避しました。",
    img: "./sample2.jpg"
  }
};

/* ----------------------------------------
   ▼ ポップアップ開閉
---------------------------------------- */
function openPopup(data) {
  popupTitle.textContent = data.title;
  popupText.textContent = data.text;

  if (data.img) {
    popupImg.src = data.img;
    popupImg.style.display = "block";
  } else {
    popupImg.style.display = "none";
  }

  popup.style.display = "block";
}

function closePopup() {
  popup.style.display = "none";
}

/* ----------------------------------------
   ▼ マーカーをクリックしたらポップアップ表示
---------------------------------------- */
document.querySelectorAll(".clickable").forEach(el => {
  el.addEventListener("click", () => {
    const data = popupData[el.id];
    if (data) openPopup(data);
  });
});

/* ----------------------------------------
   ▼ GPS更新：ログ＋ARマーカー距離に応じたスケール変化
---------------------------------------- */
window.addEventListener("gps-camera-update-position", e => {
  const { latitude, longitude } = e.detail.position;
  logs.textContent = `lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)}`;

  // 距離計算
  const toRad = d => d * Math.PI / 180;
  const R = 6371000;

  const markerIds = ["marker1", "marker2"];

  markerIds.forEach(id => {
    const markerEl = document.getElementById(id);
    if (!markerEl) return;

    const attr = markerEl.getAttribute("gps-entity-place");
    if (!attr) return;

    const targetLat = parseFloat(attr.latitude);
    const targetLon = parseFloat(attr.longitude);

    const dLat = toRad(targetLat - latitude);
    const dLon = toRad(targetLon - longitude);

    const a =
      Math.sin(dLat / 2)**2 +
      Math.cos(toRad(latitude)) *
      Math.cos(toRad(targetLat)) *
      Math.sin(dLon / 2)**2;

    const dist = 2 * R * Math.asin(Math.sqrt(a));

    // ▼ 距離に応じたスケール調整
    const minScale = 2.0;
    const maxScale = 0.8;
    const maxDist = 80;

    let d = Math.min(dist, maxDist);
    let t = d / maxDist;
    let scale = minScale * (1 - t) + maxScale * t;

    markerEl.setAttribute("scale", `${scale} ${scale} ${scale}`);

    // ▼ 透明度調整（好みで変更）
    const minOpacity = 0.5;
    const maxOpacity = 1.0;

    let opacity = minOpacity * (1 - t) + maxOpacity * t;
    markerEl.setAttribute("material", `opacity: ${opacity}`);
  });
});
</script>

</body>
</html>
