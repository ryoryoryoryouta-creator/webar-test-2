<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEBAR Image Marker</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0;overflow:hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- ▼ 画像マーカー -->
    <a-image id="marker"
      src="./marker.png"
      width="3"
      height="3"
      look-at="[gps-camera]"
      gps-entity-place="latitude: 35.83839; longitude: 139.55590;"
      visible="false">
    </a-image>

    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    const cam = document.querySelector('[gps-camera]');
    const marker = document.querySelector('#marker');
    const toRad = d => d * Math.PI / 180;
    const R = 6371000;

    function haversine(lat1, lon1, lat2, lon2) {
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    window.addEventListener('gps-camera-update-position', e => {
      const { latitude, longitude } = e.detail.position;
      const target = marker.getAttribute('gps-entity-place');
      const dist = haversine(
        latitude,
        longitude,
        parseFloat(target.latitude),
        parseFloat(target.longitude)
      );

      marker.setAttribute('visible', dist <= 20); // 20m以内で表示
    });
  </script>
</body>
</html>
