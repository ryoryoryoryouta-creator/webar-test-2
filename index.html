<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEBAR Image Popup</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; }

    /* ポップアップ（modal） */
    #popup {
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:#fff; color:#000;
      padding:20px; border-radius:12px;
      box-shadow:0 8px 25px rgba(0,0,0,.3);
      width:80%; max-width:320px;
      display:none; z-index:100;
      font-family:"Helvetica Neue",sans-serif;
    }
    #popup h2 { margin-top:0; font-size:20px; }
    #popup button {
      margin-top:15px;
      padding:8px 16px;
      border:none;
      border-radius:8px;
      background:#007aff; color:#fff;
      font-size:16px; cursor:pointer;
    }

    /* 画面オーバーレイ（ログ） */
    #logs {
      position:fixed; bottom:0; left:0; right:0;
      background:rgba(0,0,0,.5); color:#0f0;
      padding:4px; font-size:11px; z-index:50;
    }
  </style>
</head>

<body>

  <!-- ▼ ポップアップ -->
  <div id="popup">
    <h2>説明タイトル</h2>
    <p id="popupText">ここに説明文が入ります。</p>
    <button onclick="closePopup()">閉じる</button>
  </div>

  <div id="logs">準備中...</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- ▼ タップ可能な画像 -->
    <a-image id="marker"
      class="clickable"
      src="./marker.png"
      width="3"
      height="3"
      look-at="[gps-camera]"
      gps-entity-place="latitude: 35.83839; longitude: 139.55590;"
      visible="true">
    </a-image>

    <!-- カメラ（クリック用カーソルつき） -->
    <a-camera gps-camera rotation-reader>
      <a-cursor
        fuse="false"
        raycaster="objects: .clickable"
        geometry="primitive: circle; radius: 0.003"
        material="color: black; opacity: 0.8">
      </a-cursor>
    </a-camera>
  </a-scene>

  <script>
    const popup = document.getElementById("popup");
    const popupText = document.getElementById("popupText");
    const logs = document.getElementById("logs");

    // 説明文（画像1つなら固定／複数ならIDごとに設定可能）
    const descriptionText = "これはターゲット地点の説明文です。好きな文章に変更できます。";

    function openPopup() {
      popupText.textContent = descriptionText;
      popup.style.display = "block";
    }

    function closePopup() {
      popup.style.display = "none";
    }

    // ▼ マーカーをタップするとポップアップ表示
    const marker = document.getElementById("marker");
    marker.addEventListener("click", () => {
      openPopup();
    });

    // ▼ GPSログ（任意）
    window.addEventListener("gps-camera-update-position", e => {
      const { latitude, longitude } = e.detail.position;
      logs.textContent = `lat:${latitude.toFixed(6)} lon:${longitude.toFixed(6)}`;

      // ===============================
      // ▼ ここから追加：距離に応じた処理
      // ===============================

      const marker = document.getElementById("marker");

      // ターゲットの lat/lon を取得
      const attr = marker.getAttribute("gps-entity-place");
      const targetLat = parseFloat(attr.latitude);
      const targetLon = parseFloat(attr.longitude);

      // ▼ 距離計算（haversine）
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(targetLat - latitude);
      const dLon = toRad(targetLon - longitude);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(latitude)) *
        Math.cos(toRad(targetLat)) *
        Math.sin(dLon / 2) ** 2;
      const dist = 2 * R * Math.asin(Math.sqrt(a));  // メートル

      // -------------------------------
      // ▼ 距離でスケール調整
      // -------------------------------
      const minScale = 1.5;   // 近距離の最大サイズ
      const maxScale = 0.3;   // 遠距離の最小サイズ
      const maxDist  = 80;    // 80m 以上は maxScale で固定

      let d = Math.min(dist, maxDist);   // 0〜maxDist に制限
      let t = d / maxDist;               // 0〜1
      let scale = minScale * (1 - t) + maxScale * t;

      marker.setAttribute("scale", `${scale} ${scale} ${scale}`);

      // -------------------------------
      // ▼ 距離で透明度調整
      //    近い → 不透明(1.0)
      //    遠い → 透明(0.3)
      // -------------------------------
      const minOpacity = 0.3;   // 近距離での不透明度
      const maxOpacity = 1.0;   // 遠距離での透明度

      let opacity = minOpacity * (1 - t) + maxOpacity * t;

      marker.setAttribute("material", `opacity: ${opacity}`);

      // ===============================
      // ▼ ここまで追加コード
      // ===============================

    });   

  </script>

</body>
</html>
