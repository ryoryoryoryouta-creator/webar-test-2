<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>AR Navigation Demo</title>

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
      #status {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 6px 10px;
        font-size: 14px;
        z-index: 9999;
        white-space: pre-line;
      }
    </style>
  </head>

  <body style="margin:0; overflow:hidden;">
    <div id="status">📍 タップして位置情報を有効化してください</div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true;">
      <!-- 常に2m先に箱を表示 -->
      <a-box id="arrow" color="#4CC3D9" scale="0.5 0.5 2" position="0 0 -2"></a-box>
      <a-camera></a-camera>
    </a-scene>

    <script>
      const statusEl = document.getElementById("status");
      const arrow = document.getElementById("arrow");

      // 🎯 目的地（例: 適当な座標）
      const targetLat = 35.83841;
      const targetLon = 139.55606;

      // 度→ラジアン
      const toRad = (deg) => deg * Math.PI / 180;

      // 距離と方位角を計算
      function computeDistanceAndBearing(lat1, lon1, lat2, lon2) {
        const R = 6378137; // 地球半径[m]
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;

        // 方位角（北=0°から時計回り）
        const y = Math.sin(dLon) * Math.cos(toRad(lat2));
        const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) -
                  Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon);
        const bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;

        return {distance, bearing};
      }

      // 方位をコンパス風に表現
      function bearingToText(bearing) {
        const dirs = ["北","北東","東","南東","南","南西","西","北西"];
        return dirs[Math.round(bearing / 45) % 8];
      }

      document.body.addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const myLat = pos.coords.latitude;
              const myLon = pos.coords.longitude;

              const {distance, bearing} = computeDistanceAndBearing(myLat, myLon, targetLat, targetLon);

              // 箱を目的地方向に回転（Y軸を回す）
              arrow.setAttribute("rotation", `0 ${bearing} 0`);

              // UI更新
              statusEl.innerText =
                `現在地: ${myLat.toFixed(5)}, ${myLon.toFixed(5)}\n` +
                `目的地まで: 約${distance.toFixed(1)}m (${bearingToText(bearing)})`;
            },
            (err) => {
              statusEl.innerText = "❌ 位置情報エラー: " + err.message;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        }
      });
    </script>
  </body>
</html>
